<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:200,400,500" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style type="text/css">
        body{
            font-family: "Work Sans", sans-serif;
        }
        p{
            font-family: Georgia,serif;
            font-weight: 400;
            text-shadow: 0 1px 0 #FFF;
            font-size: 18px;
            line-height: 1.8;
            -webkit-font-smoothing: antialiased;
        }
        b.special{
            font-weight: 500;
            color:#61c1aa;
            font-size: 40px
        }
        a{
            color:#61c1aa;
            text-decoration: underline;
        }
        .small{
            font-weight: 200;
            font-size: 16px;
        }
        .label{
            font-size: 30px;
            font-weight: 200;
            line-height: 1.4;
        }
        .message{
            font-size: 20px;
            font-weight: 200;
            line-height: 1.4;
        }
        #pac-input{
            margin-top: 20px;
            margin-bottom: 15px;
            font-family: "Work Sans", sans-serif;
            width: 100%;
            font-size: 22px;
            padding: 15px;
            font-weight: 200;
            color: #333333;
            text-align: center;

        }
        .canton {
          fill: #bbb;
        }
        .canton-boundary {
          fill: #f5f6f7;
          stroke: #333;
          stroke-linejoin: round;
        }
        #map{
            background-color: #f5f6f7;
        }


        /**
         * Viewshed
         */

        #viewshed-container{
            display: block;
            position: relative;
            width: 100%;
        }

        #viewshed-map{
            position: absolute;
            top:0px;
            left: 0px;
            background-color: transparent;
        }

        #viewshed-map .canton-boundary{
            fill: transparent;
            stroke: #333;
            stroke-linejoin: round;
            stroke: transparent;
        }

        .park-circle{
            fill: #ffffff;
            stroke: #333333;
            opacity: 0.95;
            stroke-width:1px;
            cursor: pointer;
        }

        .user-circle{
            fill: #333333;
            stroke: #ffffff;
            opacity: 0.95;
            stroke-width:1px;
        }

        .legend-bloc{
            width: 120px;
            display: inline-block;
        }

        .legend-bloc:nth-child(1){ text-align: left; }
        .legend-bloc:nth-child(2){ text-align: center; }
        .legend-bloc:nth-child(3){ text-align: right; }


        .legend-bloc:nth-child(1) .legend-color{ background-color: #f5f6f7; }
        .legend-bloc:nth-child(2) .legend-color{ background-color: #f5f6f7; }
        .legend-bloc:nth-child(3) .legend-color{ background-color: #f5f6f7; }

        .legend-bloc:nth-child(1) .legend-text{ text-align: left; }
        .legend-bloc:nth-child(2) .legend-text{ text-align: center; }
        .legend-bloc:nth-child(3) .legend-text{ text-align: right; }

        .legend-text{
            font-size: 14px;
            line-height: 1.1em;
            font-weight: bold;
        }

        .legend-subtext{
            font-size: 14px;
            line-height: 1.1em;
            font-weight: 200;
        }

        .legend-sub-text{
            width: 30px;
            float:left;
        }

        .legend-color{
            width: 90px;
            height: 12px;
            display: inline-block;
        }

        .legend-sub-color{
            width: 30px;
            height: 12px;
            float: left;
        }

        .legend-sub-color:nth-child(1){ background-color: #d1e7e4; }
        .legend-sub-color:nth-child(2){ background-color: #9fccc1; }
        .legend-sub-color:nth-child(3){ background-color: #79b4a7; }

        /**
         * Spinner
         */

        .lds-ring {
          display: inline-block;
          position: relative;
          width: 64px;
          height: 64px;
        }
        .lds-ring div {
          box-sizing: border-box;
          display: block;
          position: absolute;
          width: 51px;
          height: 51px;
          margin: 6px;
          border: 6px solid #61c1aa;
          border-radius: 50%;
          animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
          border-color: #61c1aa transparent transparent transparent;
        }
        .lds-ring div:nth-child(1) {
          animation-delay: -0.45s;
        }
        .lds-ring div:nth-child(2) {
          animation-delay: -0.3s;
        }
        .lds-ring div:nth-child(3) {
          animation-delay: -0.15s;
        }
        @keyframes lds-ring {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        /* END Spinner */

        .message_container .message{ display: none; }
        .message_container .spinner{ display: none; }
        .message_container.loading .spinner{ display: inline-block; }
        .message_container.success .message{ display: inline-block; }

    </style>
  </head>
  <body>
    <div class="container">
        <div class="row" style="margin-bottom: 40px;">
            <div class="offset-md-2 col-md-8">
                <h1>Aliquam at urna eget ante dignissim</h1>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row" style="margin-bottom: 40px;">
            <div class="offset-md-3 col-md-6">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus in mollis ante, ut viverra magna. Nulla nunc risus, lacinia blandit turpis sit amet, condimentum venenatis ligula. Aliquam at urna eget ante dignissim vulputate. Integer sagittis tellus in vestibulum lobortis. Integer convallis ullamcorper lacus, feugiat blandit lacus finibus sit amet.</p>
            </div>
        </div>
    </div>
    <div class="container text-center">
        <div class="row">
            <div class="offset-md-2 col-md-8">
                <div class="label">Des eoliennes visibles de chez vous?</div>
                <input id="pac-input" class="controls" type="text" placeholder="Saisissez une adresse">
            </div>
        </div>
        <div class="row">
            <div class="offset-md-2 col-md-8">
                <div class="small">Essayez par exemple <a href="#">Lausanne</a>, <a href="#">Parc de Sauvabelin</a>, <a href="#">Col des Mosses</a> ou <a href="#">Lac de Joux</a>.</div>
            </div>
        </div>
        <div class="row message_container" style="margin-top: 40px; margin-bottom: 40px;">
            <div class="offset-md-2 col-md-8">
                <div><div class="spinner lds-ring"><div></div><div></div><div></div><div></div></div></div>
                <div class="message">A cettte adresse, il y a de fortes chances pour que vous puissiez voir
                <br/><b class="special">6 eoliennes</b><br/>
                <span style="text-decoration: underline;">Voici pourquoi...</span></div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row" style="margin-bottom: 40px;">
            <div class="offset-md-3 col-md-6">
                <p>Aliquam at urna eget ante dignissim vulputate. Integer sagittis tellus in vestibulum lobortis. Integer convallis ullamcorper lacus, feugiat blandit lacus finibus sit amet.</p>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row text-center">
            <div class="offset-md-2 col-md-8">
                <div class="viewshed-legend">
                    <div class="legend-bloc">
                        <div class="legend-text">Nombre d'eoliennes</div>
                        <div class="legend-color">
                            <div class="legend-sub-color"></div>
                            <div class="legend-sub-color"></div>
                            <div class="legend-sub-color"></div>
                        </div>
                        <div class="legend-subtext">
                            <div class="legend-sub-text">5</div>
                            <div class="legend-sub-text">>5</div>
                            <div class="legend-sub-text">>15</div>
                        </div>
                    </div>
                    <div class="legend-bloc">
                        <div class="legend-text">Impact visuel</div>
                        <div class="legend-color"></div>                        
                    </div>
                    <div class="legend-bloc">
                        <div class="legend-text">Forets</div>
                        <div class="legend-subtext">Visibilite nulle</div>
                        <div class="legend-color"></div>
                    </div>
                </div>
                <div id="viewshed-container">
                    <img src="viewshed_base_B.png" style="width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row text-center">
            <div class="col-md-12">
                <img src="zooms-02.png">
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row" style="margin-bottom: 40px;">
            <div class="offset-md-3 col-md-6">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus in mollis ante, ut viverra magna. Nulla nunc risus, lacinia blandit turpis sit amet, condimentum venenatis ligula. Aliquam at urna eget ante dignissim vulputate. Integer sagittis tellus in vestibulum lobortis. Integer convallis ullamcorper lacus, feugiat blandit lacus finibus sit amet.</p>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgQ6KXHrB6tMqwK-xGL3FkqiTHG_7urcE&libraries=places&language=fr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>

    <script type="text/javascript">
    
        /**
         * Viewshed
         */

        var vsProjection = d3.geoMercator();
        var vdBounds = [[5.93719220465601, 46.1162024335589],
                        [7.34809579436735, 47.0150236028029]]


        var vsPath = d3.geoPath()
            .projection(vsProjection);

        var vsMarker


        // Fit the bounding box in the svg
        
        var vdWidth = $("#viewshed-container").width()
            vdHeight = vdWidth * 
            (vsProjection(vdBounds[0])[1] - vsProjection(vdBounds[1])[1]) /
            (vsProjection(vdBounds[1])[0] - vsProjection(vdBounds[0])[0]);

        vsProjection
            .scale(1)
            .translate([0, 0]);

        var vsb = [vsProjection(vdBounds[0]), vsProjection(vdBounds[1])]
            vss = 1 / Math.max((vsb[1][0] - vsb[0][0]) / vdWidth, (vsb[1][1] - vsb[0][1]) / vdHeight),
            vst = [(vdWidth - vss * (vsb[1][0] + vsb[0][0])) / 2, (vdHeight - vss * (vsb[1][1] + vsb[0][1])) / 2];

        vsProjection
            .scale(vss)
            .translate(vst);

        // Add a test map SVG container
        var viewshedSVG = d3.select("#viewshed-container").append("svg")
            .attr("id", "viewshed-map")
            .attr("width", vdWidth)
            .attr("height", vdHeight);


        // Load the map geometry
        d3.json("vd_communes-quantized_topo.json", function(error, vd) {
            if (error) throw error;

            // add the geometries to the map
            /* viewshedSVG.append("path")
                .datum(topojson.feature(vd, vd.objects.communes, function(a, b) { return a !== b; }))
                .attr("class", "canton-boundary")
                .attr("d", vsPath);*/

            // Add the boundary box to the map
            /*bounds = viewshedSVG.append("rect")
                .attr("fill", "rgba(0,0,0,0.2)")
                .attr("x", vsProjection(vdBounds[0])[0])
                .attr("y", vsProjection(vdBounds[1])[1])
                .attr("width", vsProjection(vdBounds[1])[0] - vsProjection(vdBounds[0])[0])
                .attr("height", vsProjection(vdBounds[0])[1] - vsProjection(vdBounds[1])[1]);*/

            // Add the marker to the map
            vsMarker = viewshedSVG.append("circle")
                .attr("class", "user-circle")
                .attr("r", 3)

        });

        // Load the points
        d3.json("parcs_labels-EPSG4326.geojson", function(error, vd) {
            if (error) throw error;

            // Add the circles
            viewshedSVG.selectAll("circle")
                .data(vd.features)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    return vsProjection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[0];
                })
                .attr("cy", function(d) {
                    return vsProjection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[1];
                })
                .attr("class", "park-circle")
                .attr("r", 3);


            // Add the markers labels
            viewshedSVG.selectAll("text")
                .data(vd.features)
                .enter()
                .append("text")
                .attr("x", function(d) {
                    return vsProjection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[0];
                })
                .attr("y", function(d) {
                    return vsProjection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[1];
                })
                .attr("text", function(d) {
                    return d.properties.attribut_6;
                })

            console.log(vd)
        });
    </script>

    <script type="text/javascript">

        /*
        $("#pac-input").on("keyup", function(){
            console.log("A")
        })

        var service = new google.maps.places.AutocompleteService();
        service.getPlacePredictions({ input: 'Lausanne' }, function(predictions){
            console.log(predictions)});
        */

        var projection = d3.geoMercator();
        var vdBounds = [[5.93719220465601, 46.1162024335589],
                        [7.34809579436735, 47.0150236028029]]


        var path = d3.geoPath()
            .projection(projection);

        var marker


        // Fit the bounding box in the svg
        
        var width = 2400
            height = width * 
            (projection(vdBounds[0])[1] - projection(vdBounds[1])[1]) /
            (projection(vdBounds[1])[0] - projection(vdBounds[0])[0]);

        projection
            .scale(1)
            .translate([0, 0]);

        var b = [projection(vdBounds[0]), projection(vdBounds[1])]
            s = 1 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
            t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

        projection
            .scale(s)
            .translate(t);

        /**
         * Only for testing 
         */

        // Add a test map SVG container
        var svg = d3.select("body").append("svg")
            .attr("id", "map")
            .attr("width", width)
            .attr("height", height);


        // Load the map geometry
        d3.json("vd_communes-quantized_topo.json", function(error, vd) {
            if (error) throw error;

            // add the geometries to the map
            svg.append("path")
                .datum(topojson.feature(vd, vd.objects.communes, function(a, b) { return a !== b; }))
                .attr("class", "canton-boundary")
                .attr("d", path);

            // Add the boundary box to the map
            bounds = svg.append("rect")
                .attr("fill", "rgba(0,0,0,0.2)")
                .attr("x", projection(vdBounds[0])[0])
                .attr("y", projection(vdBounds[1])[1])
                .attr("width", projection(vdBounds[1])[0] - projection(vdBounds[0])[0])
                .attr("height", projection(vdBounds[0])[1] - projection(vdBounds[1])[1]);

            // Add the marker to the map
            marker = svg.append("circle")
                .attr("fill", "#ff00ff")
                .attr("r", 2)

        });


        /**
         * Google Place autocompletion
         */

        var APIKEY = "AIzaSyBgQ6KXHrB6tMqwK-xGL3FkqiTHG_7urcE"
        var VDBOUNDS = new google.maps.LatLngBounds(
            new google.maps.LatLng(46.200948, 5.958882),
            new google.maps.LatLng(47.008552, 7.312947));

        var input = document.getElementById('pac-input');
        var options = {
            bounds: VDBOUNDS,
            componentRestrictions: {country: 'ch'}
        };

        autocomplete = new google.maps.places.Autocomplete(input, options);
        google.maps.event.addListener(autocomplete, 'place_changed', function(){

            $(".message_container").addClass("loading")

            url = "https://maps.googleapis.com/maps/api/geocode/json?"
                + "address=" + this.getPlace().formatted_address + "&"
                + "key=" + APIKEY;

            $.ajax({
                url: url, 
                type: "GET",   
                dataType: 'json',
                cache: false,
                success: function(response){   
                    var position = response.results[0].geometry.location
                    var projectedPosition = projection([position.lng, position.lat])
                    var vsProjectedPosition = vsProjection([position.lng, position.lat])

                    marker
                        .attr("cx", projectedPosition[0])
                        .attr("cy", projectedPosition[1])

                    vsMarker
                        .attr("cx", vsProjectedPosition[0])
                        .attr("cy", vsProjectedPosition[1])

                    var pixelData = canvas.getContext('2d').getImageData(
                        projectedPosition[0], projectedPosition[1], 1, 1).data;
                    console.log(pixelData)
                    $("b.special").text(Math.ceil(pixelData[0]/5.44) > 0 ? Math.ceil(pixelData[0]/5.44) + " eoliennes" : "aucune eolienne")

                    ctx.fillRect(
                        projectedPosition[0],
                        projectedPosition[1],
                        1,1);
            
                    $(".message_container")
                        .removeClass("loading")
                        .addClass("success");

                }
            });   
        });


        /**
         * Get position value from image
         */
        var canvas = document.createElement('canvas');
        var img = new Image()
        img.src = "viewshed.png"
        img.addEventListener('load', function(){
            canvas.width = img.width;
            canvas.height = img.height;
            ctx = canvas.getContext('2d')
            ctx.fillStyle = "#ff00ff";
            ctx.drawImage(img, 0, 0, img.width, img.height);
            $("body").append($(canvas));
        });

    </script>
  </body>
</html>